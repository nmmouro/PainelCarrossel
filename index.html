<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel - Frota</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
:root{
  --bg:#071029;
  --card:#2a71e8;
  --accent:#00eaff;
  --muted:#f7f9fa;
}

html,body{
  margin:0;height:100%;
  background:var(--bg);
  color:#fff;
  font-family:Arial,Helvetica,sans-serif
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 20px;
  background:#020617;
  border-bottom:1px solid rgba(255,255,255,0.03)
}

header img{height:66px}
header .title{font-size:20px;font-weight:700;color:var(--accent)}
header .clock{font-size:18px;color:var(--muted)}

main{
  padding:12px;
  display:grid;
  grid-template-rows:1fr 1fr 1fr;
  gap:12px;
  height:calc(100vh - 90px);
  box-sizing:border-box
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:10px;
  overflow:auto
}

.card h2{
  margin:0 0 8px;
  text-align:center;
  color:var(--accent);
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:14px;
}

th,td{
  padding:6px;
  border-bottom:1px solid rgba(255,255,255,.15);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

th{
  background:#0435bf;
}

#carousel > div{width:100%}
</style>
</head>

<body>

<header>
  <img src="logo.png" onerror="this.style.display='none'">
  <div class="title">MOVIMENTAÇÃO DIÁRIA</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card">
    <h2>PAINEL</h2>
    <div id="painel">Carregando...</div>
  </section>

  <section class="card">
    <h2>AGENDA DO DIA</h2>
    <div id="agenda">Carregando...</div>
  </section>

  <section class="card">
    <h2 id="carousel-title">AGENDA SERVIÇO SOCIAL</h2>
    <div id="carousel">
      <div id="carousel-ss"></div>
      <div id="carousel-avisos" style="display:none"></div>
    </div>
  </section>
</main>

<script>
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";

const TAB_PAINEL = "PAINEL";
const TAB_AGENDA = "AGENDA DO DIA";
const TAB_SS = "AGENDA SERVIÇO SOCIAL";
const TAB_AVISOS = "AVISOS";

/* relógio */
function updateClock(){
  const n=new Date();
  clock.textContent =
    n.toLocaleDateString("pt-BR") + " — " +
    n.toLocaleTimeString("pt-BR");
}
setInterval(updateClock,1000); updateClock();

/* helpers */
function parseGviz(text){
  const i=text.indexOf("{");
  const j=text.lastIndexOf("}");
  return JSON.parse(text.slice(i,j+1));
}

function formatCell(v){
  if(v==null) return "";
  const s=String(v);
  const m=s.match(/^Date\((\d+),(\d+),(\d+),?(\d+)?,?(\d+)?/);
  if(m){
    if(m[1]==1899) return `${m[4].padStart(2,"0")}:${(m[5]||"0").padStart(2,"0")}`;
    return `${m[3].padStart(2,"0")}/${(+m[2]+1).toString().padStart(2,"0")}/${m[1]}` +
      (m[4]?` ${m[4].padStart(2,"0")}:${(m[5]||"0").padStart(2,"0")}`:"");
  }
  return s;
}

function renderTable(id, data){
  const cols=data.table.cols.map(c=>c.label||"");
  const rows=data.table.rows;

  let h="<table><thead><tr>";
  cols.forEach(c=>h+=`<th>${c}</th>`);
  h+="</tr></thead><tbody>";

  rows.forEach(r=>{
    h+="<tr>";
    r.c.forEach(c=>h+=`<td>${formatCell(c?.v)}</td>`);
    h+="</tr>";
  });

  h+="</tbody></table>";
  document.getElementById(id).innerHTML=h;
}

async function loadSheet(name){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`);
  return parseGviz(await r.text());
}

/* carrossel */
let idx=0;
function toggleCarousel(){
  carousel-ss.style.display = idx===0?"block":"none";
  carousel-avisos.style.display = idx===1?"block":"none";
  carousel-title.innerText = idx===0?TAB_SS:TAB_AVISOS;
  idx=(idx+1)%2;
}

/* main */
async function loadAll(){
  const [p,a,ss,av]=await Promise.all([
    loadSheet(TAB_PAINEL),
    loadSheet(TAB_AGENDA),
    loadSheet(TAB_SS),
    loadSheet(TAB_AVISOS)
  ]);

  renderTable("painel",p);
  renderTable("agenda",a);
  renderTable("carousel-ss",ss);
  renderTable("carousel-avisos",av);
}

loadAll();
setInterval(loadAll,60000);
setInterval(toggleCarousel,7000);
</script>

</body>
</html>
