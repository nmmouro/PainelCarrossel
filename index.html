<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel - Frota (GViz)</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
:root{
  --bg:#071029;
  --card:#2a71e8;
  --accent:#00eaff;
  --muted:#f7f9fa;
}

  #carousel > div{width:100%;
}
  table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:14px;
}
  th,td{
  text-align:left;
  padding:6px;
  border-bottom:1px solid rgba(255,255,255,.15);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

html,body{
  margin:0;height:100%;
  background:var(--bg);
  color:#fff;
  font-family:Arial,Helvetica,sans-serif
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 20px;
  background:#020617;
  border-bottom:1px solid rgba(255,255,255,0.03)
}

header img{height:66px}
header .title{font-size:20px;font-weight:700;color:var(--accent)}
header .clock{font-size:18px;color:var(--muted)}

main{
  padding:12px;
  display:grid;
  grid-template-rows:1fr 1fr 1fr;
  gap:12px;
  height:calc(100vh - 90px);
  box-sizing:border-box
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:10px;
  overflow:auto
}

.card h2{
  margin:0 0 8px;
  text-align:center;
  color:var(--accent);
}

th{
  background:#0435bf;
}
  /* carrossel */
#carousel-content{min-height:120px
}
.fade{animation:fade .6s
}
@keyframes fade{from{opacity:.2}to{opacity:1}
}

</style>
</head>

<body>

<header>
  <img src="logo.png" onerror="this.style.display='none'">
  <div class="title">MOVIMENTAÇÃO DIÁRIA</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card">
    <h2>PAINEL</h2>
    <div id="painel">Carregando...</div>
  </section>

  <section class="card">
    <h2>AGENDA DO DIA</h2>
    <div id="agenda">Carregando...</div>
  </section>

  <section class="card">
    <h2 id="carousel-title">AGENDA SERVIÇO SOCIAL</h2>
    <div id="carousel">
      <div id="carousel-ss"></div>
      <div id="carousel-avisos" style="display:none"></div>
    </div>
  </section>
</main>

  <div class="small">Atualização automática a cada 60s • Fonte: Google Sheets (GViz)</div>

<script>
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";

const TAB_PAINEL = "PAINEL";
const TAB_AGENDA = "AGENDA DO DIA";
const TAB_SS = "AGENDA SERVIÇO SOCIAL";
const TAB_AVISOS = "AVISOS";

/* relógio */
function updateClock(){
  const now = new Date();
  const optsDate = { day:"2-digit", month:"2-digit", year:"numeric" };
  const optsTime = { hour:"2-digit", minute:"2-digit", second:"2-digit" };
  document.getElementById("clock").textContent = now.toLocaleDateString("pt-BR",optsDate) + " — " + now.toLocaleTimeString("pt-BR",optsTime);
}

setInterval(updateClock,1000);
  updateClock();

/* helpers */
  function parseGviz(text){
  const i=text.indexOf("{");
  const j=text.lastIndexOf("}");
  return JSON.parse(text.slice(i,j+1));
}

function formatCell(v){
  if(v==null) return "";
  const s=String(v);
  const m=s.match(/^Date\((\d+),(\d+),(\d+),?(\d+)?,?(\d+)?/);
  if(m){
    if(m[1]==1899) return `${m[4].padStart(2,"0")}:${(m[5]||"0").padStart(2,"0")}`;
    return `${m[3].padStart(2,"0")}/${(+m[2]+1).toString().padStart(2,"0")}/${m[1]}` +
      (m[4]?` ${m[4].padStart(2,"0")}:${(m[5]||"0").padStart(2,"0")}`:"");
  }
  return s;
}

function renderTable(id, data){
  const cols=data.table.cols.map(c=>c.label||"");
  const rows=data.table.rows;

  let h="<table><thead><tr>";
  cols.forEach(c=>h+=`<th>${c}</th>`);
  h+="</tr></thead><tbody>";

  rows.forEach(r=>{
    h+="<tr>";
    r.c.forEach(c=>h+=`<td>${formatCell(c?.v)}</td>`);
    h+="</tr>";
  });

  h+="</tbody></table>";
  document.getElementById(id).innerHTML=h;
}

  /* ================= LOAD SHEETS ================= */

async function loadSheet(name){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`);
  return parseGviz(await r.text());
}

  /* ================= CARROSSEL ================= */

/* carrossel */
let carouselIndex = 0;

function toggleCarousel(){
  const title = document.getElementById("carousel-title");
  const ss = document.getElementById("carousel-ss");
  const avisos = document.getElementById("carousel-avisos");

  if (carouselIndex === 0){
    ss.style.display = "block";
    avisos.style.display = "none";
    title.innerText = "AGENDA SERVIÇO SOCIAL";
  } else {
    ss.style.display = "none";
    avisos.style.display = "block";
    title.innerText = "AVISOS";
  }

  carouselIndex = (carouselIndex + 1) % 2;
}

/* ================= MAIN ================= */

/* main */
async function loadAll(){
  const [p,a,ss,av]=await Promise.all([
    loadSheet(TAB_PAINEL),
    loadSheet(TAB_AGENDA),
    loadSheet(TAB_SS),
    loadSheet(TAB_AVISOS)
  ]);

  renderTable(containerId, sheetName, gvizJson)
  renderTable("agenda",a);
  renderTable("carousel-ss",ss);
  renderTable("carousel-avisos",av);
}
  catch(e){
    console.error(e);
  }


loadAll();
setInterval(loadAll,60000);
setInterval(toggleCarousel,6000);

</script>
</body>
</html>
